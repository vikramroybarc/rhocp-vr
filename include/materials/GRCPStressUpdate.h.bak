#include "ComputeStressBase.h"
#include "EulerAngleReader.h"
#include "EBSDMeshReader.h"
#include "GrainAreaSize.h"


// Material Class for evaluating the micro-cracking behaivour of Graphite through Crystal Plasticity
class GRCPStressUpdate : public ComputeStressBase
{
public:
  static InputParameters validParams();

  GRCPStressUpdate(const InputParameters & parameters);
  virtual ~GRCPStressUpdate();

protected:
  FileName _propsFile;
  FileName _slipSysFile;

  unsigned int _num_props;
  unsigned int _num_slip_sys;
  unsigned int _num_twin_sys;
  unsigned int _num_state_vars;

  int _grainid;

  const Real _tol;
  const VariableValue & _temp;

  const EulerAngleReader * _EulerAngFileReader;
  const EBSDMeshReader * _EBSDFileReader;
  const GrainAreaSize * _GrainAreaSize;

  Real _grain_size;
  int _isEulerRadian;
  int _isEulerBunge;
  unsigned int _iReorientTwin;

  virtual void initQpStatefulProperties();
  virtual void computeQpStress();

  Real max_val(Real a,Real b);

  MaterialProperty<Point> & _euler_ang;

  FileName _intMatfile;

  // The eigenstrains
  std::vector<MaterialPropertyName> _eigenstrain_names;
  std::vector<const MaterialProperty<RankTwoTensor> *> _eigenstrains;
  std::vector<const MaterialProperty<RankTwoTensor> *> _eigenstrains_old;



  MaterialProperty<std::vector<Real> > & _state_var;
  const MaterialProperty<std::vector<Real> > & _state_var_old;
  MaterialProperty<std::vector<Real> > & _properties;
  const MaterialProperty<std::vector<Real> > & _properties_old;

  // Miller indices of slip plane normals
  MaterialProperty<std::vector<std::vector<Real> > > & _y;
  const MaterialProperty<std::vector<std::vector<Real> > > & _y_old;
  // Miller indices of slip directions
  MaterialProperty<std::vector<std::vector<Real> > > & _z;
  const MaterialProperty<std::vector<std::vector<Real> > > & _z_old;

  const MaterialProperty<RankTwoTensor> & _deformation_gradient;
  const MaterialProperty<RankTwoTensor> & _deformation_gradient_old;
  const MaterialProperty<RankTwoTensor> & _strain_increment;
  const MaterialProperty<RankTwoTensor> & _rotation_increment;
  const MaterialProperty<RankTwoTensor> & _stress_old;
  MaterialProperty<RankFourTensor> & _Cel_cp;

  // parameters/variables used for calculations
  static const int max_loops = 20;
  void readPropsFile();
  void assignProperties();
  void normalize_vector(Real*, Real*, Real*);
  void rotate_4th(Real a[3][3], Real b[3][3][3][3], Real (&c)[3][3][3][3]);
  void forth_to_Voigt(Real a[3][3][3][3], Real (&b)[6][6]);
  void Voigt_to_forth(Real b[6][6], Real (&a)[3][3][3][3]);
  void aaaa_dot_dot_bbbb(Real a[3][3][3][3], Real b[3][3][3][3], Real (&product)[3][3][3][3]);
  void aaaa_dot_dot_bb(Real a[3][3][3][3], Real b[3][3], Real (&product)[3][3]);
  void aa_dot_bb(Real a[3][3], Real b[3][3], Real (&product)[3][3]);
  Real aa_dot_dot_bb(Real a[3][3], Real b[3][3]);
  void bunge_angles(Real (&array1)[3][3], Real (&psi0)[3]);
  Real power(Real x, Real y);
  Real sgn(Real x);

  void NR_residual (
    unsigned int num_slip_sys, 
    unsigned int num_twin_sys, 
  //  int &itvariant, 
  //  bool &TwinAllowed, 
    std::vector<std::vector<Real>> &xs0, 
    std::vector<std::vector<Real>> &xm0, 
    Real temp, 
    Real dt, 
    std::vector<Real> gamma_dot, 
    RankTwoTensor F1, 
    RankTwoTensor &F_el, 
    RankTwoTensor &F_p_inv, 
    RankTwoTensor F_p_inv0, 
    Real C[3][3][3][3], 
    std::vector<Real> &bstress0,
    std::vector<Real> &bstress,  
  //  std::vector<Real> &twin_fraction0, 
  //  std::vector<Real> &twin_fraction, 
  //  Real tot_twin_fraction, 
    RankTwoTensor &sig, 
    std::vector<Real> &tau, 
    std::vector<Real> &tau_eff, 
    std::vector<Real> &s_a, 
    std::vector<Real> &s_t,
    std::vector<Real> &sa_sdv0,
    std::vector<Real> &sa_sdv,
    std::vector<std::vector<Real>> A, 
    std::vector<std::vector<Real>> H, 
    std::vector<Real> &residual, 
    Real &sse);

  unsigned int isx(unsigned int islip);

  Real tolerance;



  // Material parameters in Props file
    // Slip system specific params
  // Index 0: Basal (0001)<1120> - 3 slip systems: 1-3
  // Index 1: Prismatic {1010}<1120> - 3 slip systems: 4-6
  // Index 2: Pyramidal {1011}<1120> - 6 slip systems: 6-12

  Real                    //    Line No in Props File 
  C11,                    //1   Elastic Constant
  C11_perK,               //2   Temperature Variation of C11 
  C12,                    //3   Elastic Constant 
  C12_perK,               //4   Temperature Variation of C12
  C13,                    //5   Elastic Constant 
  C13_perK,               //6   Temperature Variation of C13 
  C33,                    //7   Elastic Constant
  C33_perK,               //8   Temperature Variation of C33 
  C44,                    //9   Elastic Constant
  C44_perK,               //10  Temperature Variation of C44
  G,                      //11  Shear Modulus 
  G_perK,                 //12  Temperature Variation of Shear Modulus
  ca_ratio,               //13  C by A Ratio of HCP Crystal
  b_mag[4],               //13 + 14i + 1  Burger Vector Magnitude                                 (14  28   42)
  gammadot0g[4],          //13 + 14i + 2  Reference Strain Rate                                   (15  29   43)
  enthalpy_const[4],      //13 + 14i + 3  Multiplication Constant for Enthalpy Term               (16  30   44)
  p[4],                   //13 + 14i + 4  Inner Exponent of the Slip Law                          (17  31   45)
  q[4],                   //13 + 14i + 5  Outer Exponent of the slip Law                          (18  32   46)
  tau0[4],                //13 + 14i + 6  Athermal Slip Resistant Constant                        (19  33   47)
  hp_coeff[4],            //13 + 14i + 7  Hall Petch Effect Coefficient                           (20  34   48)
  grain_size[4],          //13 + 14i + 8  Grain Size for Hall-petch term                          (21  35   49)
  frictional_stress[4],   //13 + 14i + 9  Lattice Friction Resistance                             (22  36   50)
  h0[4],                  //13 + 14i + 10 Hardening Rate - Parameter of Voce Hardening Law        (23  37   51)
  ss[4],                  //13 + 14i + 11 Saturation Hardening Rate                               (24  38   52)
  m[4],                   //13 + 14i + 12 Rate Hardening Exponent                                 (25  39   53)
  k_bs1[4],               //13 + 14i + 13 Back Stress Evolution Constant 1                        (26  40   54)
  k_bs2[4],               //13 + 14i + 14 Back Stress Evolution Constant 2                        (27  41   55)
  // Twining Parameters Calculation in Props FIle
  tau_twin,               //56   Threshold Stress for Twin
  drag_twin0,             //57   Drag Stress For Twin
  gd0twin,                //58   Reference Shear Rate for Twin
  exp_twin,               //59   Rate Exponent for Twin
  gamma_twin,             //60   Characteristic Shear Rate for Twin
  twin_frac_reorient,     //61   Twining Fraction at which Reorientation Occurs
  twin_hard,              //62   Twin Hardening Parameter
  twin_hard_exp;          //63   Twin Hardening Exponent


  // Parameters Used in Twin Calculation
  Real  
  drag_twin_reorient,     
  drag_twin;              
  

  // Physical Constants -
  Real  B_k,   // Boltzmann Constant
  freq;        // Debyde Frequency

  Real sse;

  std::vector<std::vector<Real>> sintmat; // Interaction Matrix

  int numrows(std::string);
  int numcols(std::string);
  void readfile(std::string);  
};
